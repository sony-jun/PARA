{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}

{% block body %}
<div id='product_pk' data-info-id='{{ product.pk }}' class="row justify-content-center padding-page">
  <p>구매목록: {{ product.name }}</p>
  <p>작성자:{{ review.user.username }}</p>

  {% if review.review_image %}
  <div>
    <img src="{{ review.review_image.url }}" width='600px;' alt="{{review.review_image}}">
  </div>
  {% else %}
  <img src="" alt="">
  {% endif %}
  {% if review.grade == 1 %}
  <div><img src="{% static 'images/star_1.0.jpg' %}" alt=""></div>

  {% elif review.grade == 2 %}
  <div><img src="{% static 'images/star_2.0.jpg' %}" alt=""></div>
  {% elif review.grade == 3 %}
  <div><img src="{% static 'images/star_3.0.jpg' %}" alt=""></div>
  {% elif review.grade == 4 %}
  <div><img src="{% static 'images/star_4.0.jpg' %}" alt=""></div>
  {% elif review.grade == 5 %}
  <div><img src="{% static 'images/star_5.0.jpg' %}" alt=""></div>
  {% endif %}
  <p>리뷰: {{ review.content }}</p>

{% if request.user == review.user %}
  <form action="{% url 'reviews:review_delete' product.pk review.pk %}" method="POST">
    {% csrf_token %}
    <a href="{% url 'reviews:review_update' product.pk review.pk %}" class="btn btn-outline-primary"
      method="POST">수정</a>
    <input class="btn btn-outline-danger" type="submit" value="삭제">
  </form>
  {% endif %}

  <div class="container d-flex flex-column" style="z-index: 2;">
    <form id='comment-form' data-detail-id="{{ review.pk }}">
      {% csrf_token %}
      {% bootstrap_form comment_form %}
      <button class="btn btn-primary w-100">작성</button>
    </form>
    <div id="comments" class="my-5">
      {% comment %} 반복문으로 댓글 뽑음 {% endcomment %}
      {% for comment in comments %}
      <div id='com{{ comment.pk }}' class='comments_set'>
        <div class="d-flex align-items-center">
          <span class='me-auto'>
            <span class='text-muted'>작성자: {{ comment.user }}</span> - {{ comment.content}}</span>
          {% if request.user == comment.user %}
          <form data-product-id='{{ product.pk }}' data-review-id='{{ review.pk }}' data-comment-id='{{ comment.pk }}'
            action="{% url 'reviews:comment_delete' product.pk review.pk comment.pk %}" method="POST">
            {% csrf_token %}
            <input class="btn btn-outline-danger" type="submit" value="삭제">
          </form>
          {% endif %}
        </div>
        <hr>
        <br>
      </div>
      {% endfor %}
    </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>

    const product_pk = document.querySelector('#product_pk').dataset.infoId
    //console.log(product_pk)
    const commentForm = document.querySelector('#comment-form')
    const csrftoken = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value
    commentForm
      .addEventListener('submit', function (event) {
        event.preventDefault();
        axios({
          method: 'POST',
          url: `/reviews/${event.target.dataset.detailId}/review_detail/comments/`,
          headers: {
            'X-CSRFToken': csrftoken
          },
          data: new FormData(commentForm)
        })
          .then(response => {
            //console.log(response.data.comment_pk)
            //console.log(response.data.review_pk)

            const comments = document.querySelector('#comments')
            comments.insertAdjacentHTML('beforeend',
              `
            <div id ='com${response.data.comment_pk}' class='comments_set'>
            <div class="d-flex align-items-center">
              <span class='me-auto'>

                <span class='text-muted'>작성자: ${response.data.userName}</span> - ${response.data.content}</span>
                <form data-product-id='${product_pk}' data-review-id='${response.data.review_pk}' data-comment-id='${response.data.comment_pk}' action="http://127.0.0.1:8000/reviews/${product_pk}/${response.data.review_pk}/review_detail/comments/${response.data.comment_pk}/comment_delete/" method="POST">
       
                  {% csrf_token %}
                  <input class="btn btn-outline-danger" type="submit" value="삭제">
                </form>
                
            </form>
          </div>
          <hr>
          <br>
        </div>`
            );
            result = document.querySelector(`#com${response.data.comment_pk}`)
            console.log(result)
            result.addEventListener('submit', event => {
              event.preventDefault()
              //console.log(event.target.dataset)
              const product_pk = event.target.dataset.productId
              const review_pk = event.target.dataset.reviewId
              const comment_pk = event.target.dataset.commentId
              axios({
                method: 'post',
                url: `/reviews/${product_pk}/${review_pk}/review_detail/comments/${comment_pk}/comment_delete/`,
                headers: { 'X-CSRFToken': csrftoken },
              })
                .then(response => {
                  const deldiv = document.getElementById(`com${comment_pk}`)
                  console.log(deldiv)
                  deldiv.remove();
                })
            })
            commentForm.reset()
          })
          .catch(error => {
            console.log(error.response)
            if (error.response.status === 403) {
              alert("로그인을 먼저 해주세요!")
              window.location.href = '{% url "accounts:login" %}';
            }
          })
      })

    //삭제를 해보자아
    const commentDel = document.querySelectorAll('.comments_set')
    commentDel.forEach(form => {
      form.addEventListener('submit', event => {
        event.preventDefault()
        console.log(event.target.dataset)
        const product_pk = event.target.dataset.productId
        const review_pk = event.target.dataset.reviewId
        const comment_pk = event.target.dataset.commentId

        axios({
          method: 'post',
          url: `/reviews/${product_pk}/${review_pk}/review_detail/comments/${comment_pk}/comment_delete/`,
          headers: { 'X-CSRFToken': csrftoken },

        })
          .then(response => {
            const deldiv = document.getElementById(`com${comment_pk}`)
            console.log(deldiv)
            deldiv.remove();

          })
          .catch(error => {
            console.log(deldiv)
          })
      })
    })


  </script>

  {% endblock body %}